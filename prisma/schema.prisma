generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AiAnalysisStatus {
  pending
  processing
  complete
  failed
}

enum RecommendedRoute {
  DIY
  Guided
  FastTrack
}

model User {
  id           String        @id @default(uuid()) @db.Uuid
  email        String        @unique
  passwordHash String
  firstName    String?
  lastName     String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  assessments  Assessment[]
  sessions     UserSession[]
}

model UserSession {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Assessment {
  id                 String            @id @default(uuid()) @db.Uuid
  token              String            @unique @default(uuid())
  userId             String?           @db.Uuid
  user               User?             @relation(fields: [userId], references: [id], onDelete: SetNull)

  targetRoles        Json
  level              String
  compTarget         String
  timeline           String
  locationPreference String
  locationCity       String?
  hoursPerWeek       Int
  resumeStatus       String
  linkedinStatus     String
  portfolioStatus    Boolean
  interviewReady     Boolean
  resumeFileUrl      String?
  resumeFileName     String?
  resumeFileSize     Int?
  linkedinFileUrl    String?
  linkedinFileName   String?
  networkStrength    String
  outreachComfort    String
  targetCompanies    Json
  biggestBlocker     String
  additionalContext  String?

  totalScore     Int @default(0)
  clarityScore   Int @default(0)
  assetsScore    Int @default(0)
  networkScore   Int @default(0)
  executionScore Int @default(0)

  aiInsights       Json?
  aiAnalysisStatus AiAnalysisStatus @default(pending)
  aiProcessedAt    DateTime?
  aiModel          String?
  recommendedRoute RecommendedRoute?

  hasPurchasedPro     Boolean  @default(false)
  stripeSessionId     String?
  stripePaymentIntent String?
  purchaseDate        DateTime?
  purchaseAmount      Int?
  proPackData         Json?

  welcomeEmailSent Boolean @default(false)
  resultsEmailSent Boolean @default(false)
  proPackEmailSent Boolean @default(false)

  resumeParsedData   Json?
  linkedinParsedData Json?
  resumeParseStatus  String?
  linkedinParseStatus String?
  resumeParseError   String?
  linkedinParseError String?

  profileData      Json?
  resumeHealthData Json?
  skillMatchData   Json?
  taskProgress     Json?
  applications     Json?
  achievements     Json?
  chatHistory      Json?

  taskCompletions TaskCompletion[]

  ipAddress      String?
  userAgent      String?
  referralSource String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  completedAt    DateTime?

  @@index([token])
  @@index([userId])
  @@index([aiAnalysisStatus])
  @@index([createdAt])
}

model TaskCompletion {
  id           String   @id @default(uuid()) @db.Uuid
  assessmentId String   @db.Uuid
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  taskId       String
  completed    Boolean  @default(false)
  completedAt  DateTime?
  createdAt    DateTime @default(now())

  @@unique([assessmentId, taskId])
  @@index([assessmentId])
}

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  slug        String   @unique
  category    String
  description String?
  avgSalary   String?
  isPopular   Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([isPopular])
  @@index([category])
}

model Company {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @unique
  slug          String   @unique
  logoUrl       String?
  website       String?
  category      String
  employeeCount String?
  headquarters  String?
  isPopular     Boolean  @default(false)
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())

  @@index([isPopular])
  @@index([category])
}

model StripeWebhook {
  id           String   @id @default(uuid()) @db.Uuid
  eventType    String
  eventId      String   @unique
  payload      Json
  assessmentId String?  @db.Uuid
  processed    Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([eventType])
  @@index([processed])
}
